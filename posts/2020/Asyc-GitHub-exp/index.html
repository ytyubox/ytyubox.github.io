<!DOCTYPE html><html lang="zh"><head><meta charset="UTF-8"/><meta name="og:site_name" content="Tsungyu Swift dev ğŸ¦„"/><link rel="canonical" href="https://ytyubox.github.io/posts/2020/Asyc-GitHub-exp"/><meta name="twitter:url" content="https://ytyubox.github.io/posts/2020/Asyc-GitHub-exp"/><meta name="og:url" content="https://ytyubox.github.io/posts/2020/Asyc-GitHub-exp"/><meta name="google-site-verification" content="laa-5denPCh-d7LKKq_HLxpcMTXZa1R2OSU8L19KmM0"/><title>ä½¿ç”¨ Async è¼•é‡éåŒæ­¥å¥—ä»¶éˆå¼èª¿ç”¨éåŒæ­¥è¡Œç‚º | Tsungyu Swift dev ğŸ¦„</title><meta name="twitter:title" content="ä½¿ç”¨ Async è¼•é‡éåŒæ­¥å¥—ä»¶éˆå¼èª¿ç”¨éåŒæ­¥è¡Œç‚º | Tsungyu Swift dev ğŸ¦„"/><meta name="og:title" content="ä½¿ç”¨ Async è¼•é‡éåŒæ­¥å¥—ä»¶éˆå¼èª¿ç”¨éåŒæ­¥è¡Œç‚º | Tsungyu Swift dev ğŸ¦„"/><meta name="description" content="Async explain and try to extend it"/><meta name="twitter:description" content="Async explain and try to extend it"/><meta name="og:description" content="Async explain and try to extend it"/><meta name="twitter:card" content="summary"/><link rel="stylesheet" href="/styles.css" type="text/css"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><link rel="shortcut icon" href="/images/favicon.png" type="image/png"/><link rel="alternate" href="/feed.rss" type="application/rss+xml" title="Subscribe to Tsungyu Swift dev ğŸ¦„"/><meta name="twitter:image" content="https://ytyubox.github.io/Sources/Ytyubox/icon-50.jpeg"/><meta name="og:image" content="https://ytyubox.github.io/Sources/Ytyubox/icon-50.jpeg"/></head><body class="item-page"><header><div class="wrapper"><a class="site-name" href="/">Tsungyu Swift dev ğŸ¦„</a><div><script async src="https://www.googletagmanager.com/gtag/js?id=UA-155763530-1"></script><script>				window.dataLayer = window.dataLayer || [];
				function gtag(){dataLayer.push(arguments);}
				gtag('js', new Date());
				gtag('config', 'UA-155763530-1');</script></div><nav><ul><li><a class="selected" href="/posts">posts</a></li><li><a href="/about">About</a></li></ul></nav></div></header><div class="fb-root"><script async defer crossorigin="anonymous" src="https://connect.facebook.net/zh_TW/sdk.js#xfbml=1&version=v5.0&appId=1443810799117142&autoLogAppEvents=1"></script></div><div class="wrapper"><article><div class="content"><h1>ä½¿ç”¨ Async è¼•é‡éåŒæ­¥å¥—ä»¶éˆå¼èª¿ç”¨éåŒæ­¥è¡Œç‚º</h1><p>Async: <a href="https://github.com/duemunk/Async">github.com/duemunk/Async</a></p><p>2019 å¹´ä»‹ç´¹ <code>Combine</code> æ™‚ <a href="https://ithelp.ithome.com.tw/users/20119945/ironman/2272">2019éµäººè³½ä»‹ç´¹ Combine ç³»åˆ—</a>, å°æ–¼é€£çºŒçš„éåŒæ­¥äº‹ä»¶çš„èª¿ç”¨, æˆ‘å€‘æœƒé‡åˆ°å›å‘¼åœ°ç„(Callback hell), ä¹Ÿå°±æ˜¯å¤šç­†å…·ç›¸ä¾çš„éåŒæ­¥æ­¥é©ŸéŸ¿æ‡‰è¾¦æ³•.<br><br>## <code>Async</code> çš„è§£æ³• ç›¸è¼ƒæ–¼åŸæœ¬çš„ DispatchQueue çš„ç‰ˆæœ¬:</p><pre><code><span class="type">DispatchQueue</span>.<span class="call">global</span>(qos: .<span class="dotAccess">userInitiated</span>).<span class="call">async</span> {
    <span class="keyword">let</span> value = <span class="number">10</span>
    <span class="type">DispatchQueue</span>.<span class="call">global</span>(qos: .<span class="dotAccess">background</span>).<span class="call">async</span> {
        <span class="keyword">let</span> text = <span class="string">"Score:</span> \(value)<span class="string">"</span>
        <span class="type">DispatchQueue</span>.<span class="property">main</span>.<span class="call">async</span> {
            label.<span class="property">text</span> = text
        }
    }
}
</code></pre><pre><code><span class="type">Async</span>
.<span class="call">userInitiated</span> { <span class="number">10</span> }
.<span class="call">background</span> { <span class="string">"Score:</span> \($0)<span class="string">"</span>}
.<span class="call">main</span> { label.<span class="property">text</span> = $0 }
</code></pre><p><code>Async</code>å¾ˆåƒç€‘å¸ƒä¸€æ¨£, ç”±ä¸Šè‡³ä¸‹çš„æ€è€ƒéåŒæ­¥çš„åŸ·è¡Œæµç¨‹.</p><h2><code>Async</code> æ²’æœ‰å°éŒ¯èª¤æ‹‹å‡ºè™•ç† <code>throws</code></h2><p>åœ¨ç ”ç©¶äº†ä¸€æ®µæ™‚é–“ç™¼ç¾, <code>Async</code> å¾ˆå¯æƒœçš„æ²’æœ‰å° <code>Error handle</code> åšè™•ç†, æ±ºå®šç ”ç©¶äº†ä¸€ä¸‹, ä¿®æ”¹éƒ¨åˆ†çš„ç¨‹å¼ç¢¼, <a href="https://github.com/ytyubox/Async">fork repo</a>.</p><pre><code><span class="keyword">private class</span> Reference&lt;T&gt; {
        <span class="keyword">var</span> value: <span class="type">T</span>?
<span class="comment">/*æ–°å¢*/</span>    <span class="keyword">var</span> error:<span class="type">Error</span>? 
<span class="comment">/*æ–°å¢*/</span>    <span class="keyword">var</span> queue:<span class="type">GCD</span>?   
}
</code></pre><pre><code><span class="keyword">public struct</span> AsyncBlock&lt;In, Out&gt; {

    ...


    <span class="keyword">private static func</span> async&lt;O&gt;(after seconds: <span class="type">Double</span>? = <span class="keyword">nil</span>,
                                 block: <span class="keyword">@escaping</span> () <span class="keyword">throws</span> -&gt; <span class="type">O</span>,
                                 queue: <span class="type">GCD</span>) -&gt; <span class="type">AsyncBlock</span>&lt;<span class="type">Void</span>, <span class="type">O</span>&gt; {
        <span class="keyword">let</span> reference = <span class="type">Reference</span>&lt;<span class="type">O</span>&gt;()
<span class="comment">/*æ–°å¢*/</span>    reference.<span class="property">queue</span> = queue
        <span class="keyword">let</span> block = <span class="type">DispatchWorkItem</span>(block: {
<span class="comment">/*æ–°å¢*/</span>        <span class="keyword">do</span> {
<span class="comment">/*æ–°å¢*/</span>            reference.<span class="property">value</span> = <span class="keyword">try</span> <span class="call">block</span>()
<span class="comment">/*æ–°å¢*/</span>        }<span class="keyword">catch</span> {
<span class="comment">/*æ–°å¢*/</span>            reference.<span class="property">error</span> = error
<span class="comment">/*æ–°å¢*/</span>        }
        })
      ...
    }
 
    <span class="keyword">private func</span> chain&lt;O&gt;(after seconds: <span class="type">Double</span>? = <span class="keyword">nil</span>,
                          block chainingBlock: <span class="keyword">@escaping</span> (<span class="type">Out</span>) <span class="keyword">throws</span> -&gt; <span class="type">O</span>,
                          queue: <span class="type">GCD</span>) -&gt; <span class="type">AsyncBlock</span>&lt;<span class="type">Out</span>, <span class="type">O</span>&gt; {
        <span class="keyword">let</span> reference = <span class="type">Reference</span>&lt;<span class="type">O</span>&gt;()
<span class="comment">/*æ–°å¢*/</span>            reference.<span class="property">queue</span> = queue
        <span class="keyword">let</span> dispatchWorkItem = <span class="type">DispatchWorkItem</span>(block: {
<span class="comment">/*æ–°å¢*/</span>        <span class="keyword">guard let</span> value = <span class="keyword">self</span>.<span class="property">output_</span>.<span class="property">value</span> <span class="keyword">else</span> {
<span class="comment">/*æ–°å¢*/</span>            <span class="keyword">return</span> reference.<span class="property">error</span> = <span class="keyword">self</span>.<span class="property">output_</span>.<span class="property">error</span>!
<span class="comment">/*æ–°å¢*/</span>        }
<span class="comment">/*æ–°å¢*/</span>        <span class="keyword">do</span> {
<span class="comment">/*æ–°å¢*/</span>            reference.<span class="property">value</span> = <span class="keyword">try</span> <span class="call">chainingBlock</span>(value)
<span class="comment">/*æ–°å¢*/</span>        } <span class="keyword">catch</span> {
<span class="comment">/*æ–°å¢*/</span>            reference.<span class="property">error</span> = error
<span class="comment">/*æ–°å¢*/</span>        }
        })

    ...
    }

...

}
</code></pre><p>å¦‚æ­¤ä¸€ä¾†, å°±å¯ä»¥å° <code>AsyncBlock</code> æ‹“å±• <code>catch(_:)</code></p><pre><code><span class="comment">/*æ–°å¢*/</span>
<span class="keyword">@discardableResult
public func</span> `catch`(respondBlock: <span class="keyword">@escaping</span> (<span class="type">Error</span>) -&gt; <span class="type">Void</span>) -&gt; <span class="type">AsyncBlock</span>&lt;<span class="type">In</span>,<span class="type">Out</span>&gt; {
    <span class="keyword">let</span> queue = output_.<span class="property">queue</span>!.queue
    <span class="keyword">let</span> c = {
        <span class="keyword">if let</span> error = <span class="keyword">self</span>.<span class="property">output_</span>.<span class="property">error</span> {
            <span class="call">respondBlock</span>(error)
        }
    }
    <span class="keyword">let</span> item = <span class="type">DispatchWorkItem</span>(block: c)
    block.<span class="call">notify</span>(queue: queue, execute: item)
    <span class="keyword">return self</span>
}
</code></pre><p>å¯¦ä½œå–®å…ƒæ¸¬è©¦:</p><pre><code><span class="keyword">func</span> testAsyncMainWithCatch() {
    <span class="keyword">let</span> expectation = <span class="keyword">self</span>.<span class="call">expectation</span>(description: <span class="string">"Expected on main queue"</span>)
    <span class="keyword">var</span> calledStuffAfterSinceAsync = <span class="keyword">false</span>
    <span class="type">Async</span>.<span class="call">main</span> {
        <span class="keyword">try self</span>.<span class="call">alwaysError</span>()
    }.<span class="keyword">catch</span> { (error) <span class="keyword">in</span>
        <span class="preprocessing">#if targetEnvironment(simulator)</span>
        <span class="call">XCTAssert</span>(<span class="type">Thread</span>.<span class="property">isMainThread</span>, <span class="string">"Should be on main thread (simulator)"</span>)
        <span class="preprocessing">#else</span>
        <span class="call">XCTAssertEqual</span>(<span class="call">qos_class_self</span>(), <span class="call">qos_class_main</span>())
        <span class="preprocessing">#endif</span>
        <span class="call">XCTAssert</span>(calledStuffAfterSinceAsync, <span class="string">"Should be async"</span>)
        expectation.<span class="call">fulfill</span>()
    }
    calledStuffAfterSinceAsync = <span class="keyword">true</span>
    waitForExpectations(timeout: timeMargin, handler: <span class="keyword">nil</span>)
}
</code></pre><p>ä»¥ä¸Š, æ–¼ fork çš„ GitHub project å…§æŒçºŒè£œä¸Š test case! GitHub é€£çµ: https://github.com/ytyubox/Async</p></div><span>Tagged with: </span><ul class="tag-list"><li><a href="/tags/spm">SPM</a></li><li><a href="/tags/swift">Swift</a></li></ul></article></div><div class="fb-comments" data-herf="https://ytyubox.github.io/posts/2020/Asyc-GitHub-exp" data-width data-numposts="10" colorscheme="dark"></div><footer><p>Generated using <a href="https://github.com/johnsundell/publish">Publish</a>, 100% Swift</p><p><a href="/feed.rss">RSS feed</a></p></footer></body></html>